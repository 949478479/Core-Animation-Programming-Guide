# 提高动画性能

- 尽可能地使用不透明的图层

  设置图层的 `opaque` 属性为 `true` 可以向核心动画表明该图层不需要透明通道。没有透明通道意味着合成器不需要混合图层内容及其背后图层的内容，这将节省很多渲染时间。然而，该属性仅仅影响图层本身，例如，将一张带有透明通道的图片设置为图层的 `contents` 时，无论 `opaque` 属性是什么，图层将依旧保有透明通道。
  
- 使用简单的路径

  `CAShapeLayer` 会根据指定的路径创建图层内容，并在合成时将其渲染到一张位图中。`CAShapeLayer` 会尽可能地以最佳分辨率来绘制路径，但这也将耗费更多的渲染时间。如果路径很复杂，对路径进行栅格化的代价就会更为昂贵。又如果图层的尺寸频繁改变，也就意味着图层需要频繁重绘，这将增加渲染的时间花费，并可能成为性能瓶颈。一种优化方式是将复杂的路径分解成多个简单的路径，并分散到多个 `CAShapeLayer` 中。然而，在试图优化之前先进行测量，确定性能瓶颈的真正所在。
  
- 直接为内容相同的图层设置内容

  将同一张图片设置为多个图层的 `contents` 时，图层不会开辟后备存储，而是使用图片作为后备存储。多个图层共用同一张图片时，它们共用同一个后备存储，大大节省了内存。
  
- 将图层的尺寸设置为整型值

  虽然可以设置为浮点值，但是设置为整型值可以简化核心动画创建以及管理图层的后备存储和其他信息的工作。
  
- 在必要时使用异步渲染

  在图层代理的 `drawLayer(_:inContext:)` 方法，或者视图的 `drawRect(_:)` 方法中的绘制操作都会在主线程同步执行。开启图层的 `drawsAsynchronously` 属性后，可以将这些操作移到后台线程，但须确保绘制操作是线程安全的。在开启异步渲染后一定要测量性能，确保该优化确实提高了性能。
  
- 使用阴影时指定阴影路径

  让核心动画来计算阴影形状的代价十分昂贵，可能会影响性能。相反，通过图层的 `shadowPath` 属性明确指定阴影路径后，核心动画会直接根据该路径绘制阴影并缓存阴影效果。如果图层的阴影从不变化或者基本不会变化，相较于让核心动画计算阴影，这将提高不少渲染性能。